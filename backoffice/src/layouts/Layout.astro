---
export interface Props {
	title: string;
}

const { title } = Astro.props;
---

<!doctype html>
<html lang="it">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="MetaModel Dynamic CMS Backoffice" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<title>{title}</title>
		<link rel="stylesheet" href="/src/styles/global.css" />
	</head>
	<body>
		<div class="content-wrapper">
			<!-- Header con navigazione -->
			<header class="header">
				<div class="container">
					<nav class="nav">
						<a href="/" class="logo">ðŸŽ¯ MetaModel CMS</a>
						
						<ul class="nav-links">
							<li><a href="/">Dashboard</a></li>
							<li><a href="/models">Models</a></li>
							<li><a href="/data">Data</a></li>
						</ul>
						
						<div class="user-info">
							<span id="user-display"></span>
							<button class="btn btn-secondary btn-sm" onclick="handleLogout()">Logout</button>
						</div>
					</nav>
				</div>
			</header>
			
			<!-- Main content -->
			<main class="main-content">
				<div class="container">
					<slot />
				</div>
			</main>
		</div>
		
		<script>
			// Import AuthManager
			import('/src/utils/authManager.js').then(module => {
				window.AuthManager = module.default;
				initializeAuth();
			}).catch(() => {
				// Fallback se il modulo non si carica
				initializeAuth();
			});

			function initializeAuth() {
				// Mostra info utente se loggato
				const userInfo = window.AuthManager ? 
					window.AuthManager.getUserInfo() : 
					JSON.parse(localStorage.getItem('userInfo') || 'null');
				
				if (userInfo) {
					const userDisplay = document.getElementById('user-display');
					if (userDisplay) {
						userDisplay.textContent = `ðŸ‘‹ ${userInfo.username}`;
					}
				}
				
				// Controllo autenticazione per pagine protette
				if (window.location.pathname !== '/login') {
					const isAuth = window.AuthManager ? 
						window.AuthManager.isAuthenticated() : 
						!!localStorage.getItem('authToken');
					
					if (!isAuth) {
						window.location.href = '/login';
					}
				} else if (window.AuthManager ? window.AuthManager.isAuthenticated() : !!localStorage.getItem('authToken')) {
					// Se giÃ  loggato e nella pagina login, redirect alla home
					window.location.href = '/';
				}
			}

			// Gestione logout con AuthManager
			window.handleLogout = async function() {
				if (window.AuthManager) {
					await window.AuthManager.logout();
				} else {
					// Fallback al metodo originale
					try {
						const token = localStorage.getItem('authToken');
						if (token) {
							await fetch('http://localhost:8000/auth/logout/', {
								method: 'POST',
								headers: {
									'Authorization': `Token ${token}`,
									'Content-Type': 'application/json'
								}
							});
						}
					} catch (error) {
						console.log('Logout API error (non critical):', error);
					}
					
					localStorage.removeItem('authToken');
					localStorage.removeItem('userInfo');
					window.location.href = '/login';
				}
			};

			// Inizializza immediatamente se possibile
			document.addEventListener('DOMContentLoaded', function() {
				if (!window.AuthManager) {
					initializeAuth();
				}
			});
		</script>
	</body>
</html>