---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Gestione Modelli">
	<div class="container">
		<div class="card">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding: 1.5rem 1.5rem 0 1.5rem;">
				<div>
					<h2 style="margin: 0; color: #2c3e50;">ğŸ—ï¸ Gestione Modelli Dinamici</h2>
					<p style="margin: 0.5rem 0 0 0; color: #7f8c8d;">Crea e gestisci i tuoi modelli di dati dinamici</p>
				</div>
				<a href="/models/new" class="btn btn-success">â• Nuovo Modello</a>
			</div>
			<div id="models-list" style="padding: 0 1.5rem 1.5rem 1.5rem;">
				<p>ğŸ”„ Caricamento modelli...</p>
			</div>
		</div>
	</div>
	
	<script>
		async function loadModels() {
			try {
				const response = await fetch('http://localhost:8000/api/meta-models/', {
					credentials: 'include'
				});
				const data = await response.json();
				const models = data.results || data;
				
				const listEl = document.getElementById('models-list');
				if (!listEl) return;
				
				if (models.length === 0) {
					listEl.innerHTML = `
						<div style="text-align: center; padding: 3rem; color: #7f8c8d;">
							<div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“‹</div>
							<h3 style="margin-bottom: 1rem; color: #2c3e50;">Nessun modello ancora creato</h3>
							<p style="margin-bottom: 1.5rem;">Inizia creando il tuo primo modello dinamico</p>
							<a href="/models/new" class="btn btn-primary">â• Crea il primo modello</a>
						</div>
					`;
					return;
				}
				
				let html = '<div style="display: grid; gap: 1rem;">';
				
				models.forEach((model) => {
					html += `
						<div class="card" style="border-left: 4px solid ${model.is_active ? '#27ae60' : '#e74c3c'};">
							<div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem;">
								<div style="flex: 1; margin-right: 1rem;">
									<h3 style="margin: 0 0 1rem 0; color: #2c3e50;">${model.name}</h3>
									<p style="margin: 0.25rem 0;"><strong>Tabella:</strong> ${model.table_name}</p>
									<p style="margin: 0.25rem 0;"><strong>Descrizione:</strong> ${model.description || 'Nessuna descrizione'}</p>
									<p style="margin: 0.25rem 0;"><strong>Campi:</strong> ${model.meta_fields ? model.meta_fields.length : 0}</p>
									<p style="margin: 0.25rem 0;"><strong>Stato:</strong> ${model.is_active ? 'âœ… Attivo' : 'âŒ Inattivo'}</p>
								</div>
								<div style="display: flex; flex-direction: column; gap: 0.5rem; min-width: 120px;">
									<a href="/models/${model.id}/edit" class="btn">âœï¸ Modifica</a>
									<a href="/data/${model.name}" class="btn">ğŸ“Š Dati</a>
									<button onclick="createTable(${model.id})" class="btn btn-success">ğŸ”§ Crea Tabella</button>
									<button onclick="updateTable(${model.id})" class="btn">ğŸ”„ Aggiorna</button>
									<button onclick="deleteModel(${model.id})" class="btn btn-danger">ğŸ—‘ï¸ Elimina</button>
								</div>
							</div>
						</div>
					`;
				});
				
				html += '</div>';
				listEl.innerHTML = html;
				
			} catch (error) {
				const listEl = document.getElementById('models-list');
				if (listEl) {
					listEl.innerHTML = `
						<div style="text-align: center; padding: 3rem; color: #e74c3c;">
							<div style="font-size: 3rem; margin-bottom: 1rem;">âš ï¸</div>
							<h3 style="margin-bottom: 1rem; color: #c0392b;">Errore di connessione</h3>
							<p style="margin-bottom: 1.5rem;">Impossibile caricare i modelli. Verifica che il server Django sia attivo.</p>
							<button onclick="loadModels()" class="btn btn-primary">ğŸ”„ Riprova</button>
						</div>
					`;
				}
			}
		}
		
		async function createTable(modelId) {
			try {
				const response = await fetch(`http://localhost:8000/api/meta-models/${modelId}/create_table/`, {
					method: 'POST',
					credentials: 'include'
				});
				
				if (response.ok) {
					alert('âœ… Tabella creata con successo!');
				} else {
					alert('âŒ Errore nella creazione della tabella');
				}
			} catch (error) {
				alert('âŒ Errore di connessione');
			}
		}
		
		async function updateTable(modelId) {
			try {
				const response = await fetch(`http://localhost:8000/api/meta-models/${modelId}/update_table/`, {
					method: 'POST',
					credentials: 'include'
				});
				
				if (response.ok) {
					alert('âœ… Tabella aggiornata con successo!');
				} else {
					alert('âŒ Errore nell\'aggiornamento della tabella');
				}
			} catch (error) {
				alert('âŒ Errore di connessione');
			}
		}
		
		async function deleteModel(modelId) {
			if (!confirm('Sei sicuro di voler eliminare questo modello?')) return;
			
			try {
				const response = await fetch(`http://localhost:8000/api/meta-models/${modelId}/`, {
					method: 'DELETE',
					credentials: 'include'
				});
				
				if (response.ok) {
					alert('âœ… Modello eliminato con successo!');
					loadModels(); // Ricarica la lista
				} else {
					alert('âŒ Errore nell\'eliminazione del modello');
				}
			} catch (error) {
				alert('âŒ Errore di connessione');
			}
		}
		
		// Carica modelli al load della pagina
		loadModels();
	</script>
</Layout>