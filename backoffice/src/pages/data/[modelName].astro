---
import Layout from '../../layouts/Layout.astro';

// Per le route dinamiche in modalit√† hybrid, forziamo il rendering server-side
export const prerender = false;

export function getStaticPaths() {
  // Array vuoto significa che tutte le richieste saranno gestite server-side
  return [];
}

const { modelName } = Astro.params;
---

<Layout title={`Gestione Dati: ${modelName} - MetaModel CMS`}>
	<div class="page-header">
		<div class="flex justify-between items-center">
			<div>
				<h1 class="page-title">üìù Gestione Dati: <span id="model-name">{modelName}</span></h1>
				<p class="page-subtitle">Visualizza, aggiungi e modifica i record del modello</p>
			</div>
			<div class="flex gap-3">
				<button onclick="goBack()" class="btn btn-secondary">‚Üê Indietro</button>
				<button class="btn btn-primary" onclick="showAddModal()">‚ûï Nuovo Record</button>
			</div>
		</div>
	</div>

	<!-- Loading state -->
	<div id="loading" class="text-center">
		<div class="loading"></div>
		<p class="text-muted mt-2">Caricamento dati...</p>
	</div>

	<!-- Content -->
	<div id="content" style="display: none;">
		<!-- Stats -->
		<div class="grid grid-cols-1 grid-cols-3 mb-4">
			<div class="card">
				<div class="card-body">
					<div class="flex items-center justify-between">
						<div>
							<p class="text-muted text-small">Record Totali</p>
							<p class="stat-number" id="total-records">0</p>
						</div>
						<div class="stat-icon">üìä</div>
					</div>
				</div>
			</div>
			<div class="card">
				<div class="card-body">
					<div class="flex items-center justify-between">
						<div>
							<p class="text-muted text-small">Campi Modello</p>
							<p class="stat-number" id="total-fields">0</p>
						</div>
						<div class="stat-icon">üîß</div>
					</div>
				</div>
			</div>
			<div class="card">
				<div class="card-body">
					<div class="flex items-center justify-between">
						<div>
							<p class="text-muted text-small">API Status</p>
							<p class="stat-number" id="api-status">üîÑ</p>
						</div>
						<div class="stat-icon">üîå</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Filters & Search -->
		<div class="card mb-4">
			<div class="card-body">
				<div class="flex gap-3 items-center">
					<div class="flex-1">
						<input 
							type="search" 
							id="search-input" 
							placeholder="Cerca nei record..." 
							class="form-input"
						>
					</div>
					<button class="btn btn-secondary" onclick="refreshData()">üîÑ Aggiorna</button>
				</div>
			</div>
		</div>

		<!-- Data Table -->
		<div class="card">
			<div class="card-header">
				<h2 class="card-title">üìã Record del Modello</h2>
			</div>
			<div class="card-body">
				<div class="table-responsive">
					<table class="table" id="data-table">
						<thead id="table-header">
							<!-- Header generato dinamicamente -->
						</thead>
						<tbody id="table-body">
							<!-- Dati generati dinamicamente -->
						</tbody>
					</table>
				</div>
				<div id="no-data" style="display: none;" class="text-center">
					<p class="text-muted">Nessun record trovato</p>
					<button class="btn btn-primary" onclick="showAddModal()">Aggiungi il primo record</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Error state -->
	<div id="error" style="display: none;" class="alert alert-error">
		<p>Errore nel caricamento dei dati. Possibili cause:</p>
		<ul>
			<li>Il modello "<strong id="error-model-name">{modelName}</strong>" non esiste</li>
			<li>Il server Django non √® raggiungibile</li>
			<li>Non hai i permessi per accedere a questi dati</li>
		</ul>
		<div class="mt-3">
			<button onclick="goBack()" class="btn btn-secondary">‚Üê Torna ai Dati</button>
			<button class="btn btn-primary" onclick="location.reload()">Riprova</button>
		</div>
	</div>

	<!-- Modal per aggiungere/modificare record -->
	<div id="record-modal" class="modal" style="display: none;">
		<div class="modal-content card" style="max-width: 600px; margin: 2rem auto;">
			<div class="card-header">
				<h3 class="card-title" id="modal-title">Nuovo Record</h3>
			</div>
			<div class="card-body">
				<div id="vue-form-container"></div>
			</div>
		</div>
	</div>
</Layout>

<style>
	.page-header {
		margin-bottom: 2rem;
		padding-bottom: 1rem;
		border-bottom: 1px solid #e2e8f0;
	}
	
	.page-title {
		font-size: 2rem;
		font-weight: 700;
		color: #1a202c;
		margin: 0 0 0.5rem 0;
	}
	
	.page-subtitle {
		color: #718096;
		margin: 0;
		font-size: 1rem;
	}
	
	.stat-number {
		font-size: 1.5rem;
		font-weight: 700;
		color: #1a202c;
		margin: 0;
	}
	
	.stat-icon {
		font-size: 1.5rem;
		opacity: 0.7;
	}
	
	.modal {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0,0,0,0.5);
		z-index: 1000;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 1rem;
	}
	
	.modal-content {
		background: white;
		width: 100%;
		max-height: 90vh;
		overflow-y: auto;
	}
	
	.table-responsive {
		overflow-x: auto;
		max-width: 100%;
	}

	/* Image preview styles */
	.image-preview {
		max-width: 150px;
		max-height: 150px;
		object-fit: cover;
		border-radius: 0.375rem;
		border: 1px solid #d1d5db;
		transition: transform 0.2s ease;
		cursor: pointer;
	}

	.image-preview:hover {
		transform: scale(1.05);
	}

	.table img {
		max-height: 48px;
		max-width: 48px;
		object-fit: cover;
		border-radius: 0.25rem;
	}

	/* Form Styles */
	.form-group {
		margin-bottom: 1.5rem;
	}

	.form-label {
		display: block;
		margin-bottom: 0.5rem;
		font-size: 0.875rem;
		font-weight: 500;
		color: #374151;
	}

	.form-input, .form-textarea, .form-select {
		width: 100%;
		padding: 0.75rem;
		border: 1px solid #d1d5db;
		border-radius: 0.375rem;
		font-size: 0.875rem;
		transition: border-color 0.2s, box-shadow 0.2s;
		background: white;
	}

	.form-input:focus, .form-textarea:focus, .form-select:focus {
		outline: none;
		border-color: #3b82f6;
		box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
	}

	.form-textarea {
		resize: vertical;
		min-height: 100px;
	}

	.form-checkbox {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.form-checkbox input[type="checkbox"] {
		width: 1rem;
		height: 1rem;
		accent-color: #3b82f6;
	}

	.required {
		color: #ef4444;
	}

	.file-input {
		border: 2px dashed #d1d5db;
		background: #f9fafb;
		cursor: pointer;
		transition: border-color 0.2s, background-color 0.2s;
	}

	.file-input:hover {
		border-color: #9ca3af;
		background: #f3f4f6;
	}

	.file-input:focus {
		border-color: #3b82f6;
		background: white;
	}

	.help-text {
		margin-top: 0.25rem;
		font-size: 0.75rem;
		color: #6b7280;
	}

	.form-actions {
		display: flex;
		gap: 0.75rem;
		margin-top: 2rem;
		padding-top: 1rem;
		border-top: 1px solid #e2e8f0;
	}

	.space-y-4 > * + * {
		margin-top: 1rem;
	}
	
	@media (max-width: 768px) {
		.grid-cols-3 {
			grid-template-columns: 1fr;
		}
		
		.page-header .flex {
			flex-direction: column;
			gap: 1rem;
			align-items: flex-start;
		}
	}
</style>

<script>
	const modelName = window.location.pathname.split('/').pop();
	let currentModel = null;
	let currentData = [];

	document.addEventListener('DOMContentLoaded', async function() {
		await loadModelAndData();
	});

	async function loadModelAndData() {
		try {
			const token = localStorage.getItem('authToken');
			
			// Prima verifica lo status dell'API
			document.getElementById('api-status')!.textContent = 'üîÑ';
			
			// Carica informazioni del modello
			const modelsResponse = await fetch('http://localhost:8000/api/meta-models/', {
				headers: {
					'Authorization': `Token ${token}`,
					'Content-Type': 'application/json'
				}
			});

			if (!modelsResponse.ok) throw new Error('Errore nel caricamento modelli');

			const modelsData = await modelsResponse.json();
			const models = modelsData.results || modelsData;
			currentModel = models.find(m => m.name === modelName);

			if (!currentModel) {
				throw new Error(`Modello ${modelName} non trovato`);
			}

			// API OK
			document.getElementById('api-status')!.textContent = '‚úÖ';
			document.getElementById('api-status')!.style.color = '#10b981';

			// Carica i dati del modello
			const dataResponse = await fetch(`http://localhost:8000/api/data/${modelName}/`, {
				headers: {
					'Authorization': `Token ${token}`,
					'Content-Type': 'application/json'
				}
			});

			if (dataResponse.ok) {
				const responseData = await dataResponse.json();
				currentData = responseData.results || responseData;
			} else {
				currentData = []; // Modello senza dati
			}

			// Aggiorna l'interfaccia
			updateStats();
			renderTable();

			document.getElementById('loading')!.style.display = 'none';
			document.getElementById('content')!.style.display = 'block';

		} catch (error) {
			console.error('Errore:', error);
			document.getElementById('api-status')!.textContent = '‚ùå';
			document.getElementById('api-status')!.style.color = '#ef4444';
			document.getElementById('loading')!.style.display = 'none';
			document.getElementById('error')!.style.display = 'block';
		}
	}

	function updateStats() {
		document.getElementById('total-records')!.textContent = currentData.length.toString();
		document.getElementById('total-fields')!.textContent = (currentModel?.meta_fields?.length || 0).toString();
	}

	function renderTable() {
		const headerEl = document.getElementById('table-header')!;
		const bodyEl = document.getElementById('table-body')!;
		const noDataEl = document.getElementById('no-data')!;

		if (!currentModel || !currentModel.meta_fields || currentModel.meta_fields.length === 0) {
			headerEl.innerHTML = '<tr><th>ID</th><th>Azioni</th></tr>';
			bodyEl.innerHTML = '<tr><td colspan="2" class="text-center text-muted">Modello senza campi definiti</td></tr>';
			return;
		}

		// Render header
		const headers = ['ID', ...currentModel.meta_fields.map(f => f.verbose_name || f.name), 'Azioni'];
		headerEl.innerHTML = `
			<tr>
				${headers.map(h => `<th>${h}</th>`).join('')}
			</tr>
		`;

		// Render data
		if (currentData.length === 0) {
			bodyEl.innerHTML = `<tr><td colspan="${headers.length}" class="text-center text-muted">Nessun record trovato</td></tr>`;
			noDataEl.style.display = 'block';
		} else {
			noDataEl.style.display = 'none';
			bodyEl.innerHTML = currentData.map(record => {
				const cells = [
					record.id || '-',
					...currentModel.meta_fields.map(field => formatFieldValue(record[field.name], field.field_type)),
					`
						<div class="flex gap-2">
							<button class="btn btn-secondary btn-sm" onclick="editRecord(${record.id})">‚úèÔ∏è</button>
							<button class="btn btn-danger btn-sm" onclick="deleteRecord(${record.id})">üóëÔ∏è</button>
						</div>
					`
				];
				return `<tr>${cells.map(c => `<td>${c}</td>`).join('')}</tr>`;
			}).join('');
		}
	}

	function formatFieldValue(value, fieldType) {
		if (value === null || value === undefined) return '-';
		
		switch (fieldType) {
			case 'boolean':
				return value ? '‚úÖ S√¨' : '‚ùå No';
			case 'date':
				return new Date(value).toLocaleDateString('it-IT');
			case 'datetime':
				return new Date(value).toLocaleString('it-IT');
			case 'url':
				return `<a href="${value}" target="_blank" class="text-primary">${value}</a>`;
			case 'email':
				return `<a href="mailto:${value}" class="text-primary">${value}</a>`;
			case 'file':
				if (!value) return '-';
				const fileName = value.split('/').pop();
				// Gestisce sia URL completi che path relativi
				const fileUrl = value.startsWith('http') ? value : `http://localhost:8000${value.startsWith('/') ? '' : '/media/'}${value}`;
				return `<a href="${fileUrl}" target="_blank" class="text-blue-600">üìÑ ${fileName}</a>`;
			case 'image':
				if (!value) return '-';
				const imageName = value.split('/').pop();
				// Gestisce sia URL completi che path relativi
				const imageUrl = value.startsWith('http') ? value : `http://localhost:8000${value.startsWith('/') ? '' : '/media/'}${value}`;
				return `
					<div class="flex items-center gap-2">
						<img src="${imageUrl}" alt="${imageName}" class="image-preview cursor-pointer" style="max-height: 48px; max-width: 48px;" onclick="window.open('${imageUrl}', '_blank')" />
						<a href="${imageUrl}" target="_blank" class="text-blue-600">üñºÔ∏è ${imageName}</a>
					</div>
				`;
			default:
				return value.toString().length > 50 ? value.toString().substring(0, 50) + '...' : value;
		}
	}

	// Modal functions con Vue
	function showAddModal() {
		document.getElementById('modal-title')!.textContent = 'Nuovo Record';
		createVueForm();
		document.getElementById('record-modal')!.style.display = 'flex';
	}

	function editRecord(id) {
		const record = currentData.find(r => r.id === id);
		if (!record) return;

		document.getElementById('modal-title')!.textContent = 'Modifica Record';
		createVueForm(record);
		document.getElementById('record-modal')!.style.display = 'flex';
	}

	// Mappa i tipi Django field ai componenti Vue
	const FIELD_COMPONENT_MAP = {
		'CharField': 'CharField',
		'TextField': 'TextField',  
		'IntegerField': 'NumberField',
		'FloatField': 'NumberField',
		'BooleanField': 'BooleanField',
		'DateField': 'DateField',
		'DateTimeField': 'DateField',
		'EmailField': 'EmailField',
		'URLField': 'URLField',
		'ForeignKey': 'SelectField' // Per le foreign key useremo un SelectField
	};

	// Crea il form (torniamo a HTML semplice ma con widget migliori)
	function createVueForm(initialData = null) {
		const container = document.getElementById('vue-form-container');
		if (!container || !currentModel?.meta_fields) return;

		const isEditing = !!initialData;
		const formData = initialData || {};

		// Genera HTML migliorato con widget specifici
		container.innerHTML = `
			<form id="record-form" class="space-y-4">
				${currentModel.meta_fields.map(field => generateFieldWidget(field, formData[field.name])).join('')}
				<div class="flex gap-3 mt-6 pt-4 border-t">
					<button type="button" class="btn btn-secondary" onclick="closeRecordModal()">
						Annulla
					</button>
					<button type="submit" class="btn btn-primary">
						üíæ ${isEditing ? 'Aggiorna' : 'Salva'}
					</button>
				</div>
			</form>
		`;

		// Per le ForeignKey, imposta i valori attuali come data-attribute prima di caricare le opzioni
		if (isEditing && initialData) {
			currentModel.meta_fields.forEach(field => {
				if (field.field_type === 'foreign_key' && formData[field.name]) {
					const selectElement = document.querySelector(`select[data-foreign-key="${field.related_model || field.name}"]`);
					if (selectElement) {
						selectElement.setAttribute('data-current-value', formData[field.name]);
					}
				}
			});
		}

		// Carica le opzioni per i campi ForeignKey
		loadForeignKeyOptions();

		// Attach event listener
		const form = document.getElementById('record-form');
		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData(form);
			
			// Verifica se ci sono file nel form
			let hasFiles = false;
			for (let [key, value] of formData.entries()) {
				if (value instanceof File && value.size > 0) {
					hasFiles = true;
					break;
				}
			}
			
			// Se ci sono file, invia FormData direttamente
			// Altrimenti, converti in JSON come prima
			let recordData;
			if (hasFiles) {
				recordData = formData; // Mantieni FormData per i file
				
				// Aggiungi i campi "keep_*" per i file esistenti che non sono stati sostituiti
				currentModel.meta_fields.forEach(field => {
					if ((field.field_type === 'file' || field.field_type === 'image') && isEditing && initialData[field.name]) {
						const fileInput = formData.get(field.name);
						// Se non √® stato selezionato un nuovo file, mantieni quello esistente
						if (!fileInput || (fileInput instanceof File && fileInput.size === 0)) {
							formData.delete(field.name); // Rimuovi il campo file vuoto
							formData.set(`keep_${field.name}`, initialData[field.name]); // Indica di mantenere il file esistente
						}
					}
				});
			} else {
				// Converti in oggetto JSON come prima
				recordData = {};
				currentModel.meta_fields.forEach(field => {
					const value = formData.get(field.name);
					switch (field.field_type) {
						case 'boolean':
							recordData[field.name] = formData.has(field.name);
							break;
						case 'integer':
							recordData[field.name] = value ? parseInt(value.toString()) : null;
							break;
						case 'decimal':
							recordData[field.name] = value ? parseFloat(value.toString()) : null;
							break;
						case 'foreign_key':
							recordData[field.name] = value ? parseInt(value.toString()) : null;
							break;
						default:
							recordData[field.name] = value ? value.toString() : null;
					}
				});
			}

			try {
				await saveRecord(recordData, isEditing ? initialData.id : null, hasFiles);
				closeRecordModal();
				showSuccessMessage(isEditing ? 'Record aggiornato con successo!' : 'Record creato con successo!');
			} catch (error) {
				console.error('Errore salvataggio:', error);
				alert('‚ùå Errore nel salvataggio del record');
			}
		});
	}

	// Genera widget HTML specifici per ogni tipo di campo
	function generateFieldWidget(field, value = '') {
		const inputId = `field_${field.name}`;
		const label = field.verbose_name || field.name;
		const required = field.required ? 'required' : '';
		const helpText = field.help_text ? `<p class="help-text">${field.help_text}</p>` : '';
		
		// Debug: mostra il tipo di campo effettivo
		console.log(`Campo ${field.name}: tipo=${field.field_type}`, field);
		
		let widget = '';
		
		switch (field.field_type) {
			case 'text':
				widget = `<textarea id="${inputId}" name="${field.name}" class="form-textarea" ${required} rows="4" placeholder="Inserisci ${label.toLowerCase()}...">${value || ''}</textarea>`;
				break;
				
			case 'boolean':
				const checked = value ? 'checked' : '';
				return `
					<div class="form-group">
						<div class="form-checkbox">
							<input type="checkbox" id="${inputId}" name="${field.name}" ${checked}>
							<label for="${inputId}">${label} ${field.required ? '<span class="required">*</span>' : ''}</label>
						</div>
						${helpText}
					</div>
				`;
				
			case 'integer':
				widget = `<input type="number" id="${inputId}" name="${field.name}" class="form-input" value="${value || ''}" ${required} placeholder="Inserisci ${label.toLowerCase()}...">`;
				break;
				
			case 'decimal':
				widget = `<input type="number" step="0.01" id="${inputId}" name="${field.name}" class="form-input" value="${value || ''}" ${required} placeholder="Inserisci ${label.toLowerCase()}...">`;
				break;
				
			case 'date':
				widget = `<input type="date" id="${inputId}" name="${field.name}" class="form-input" value="${value || ''}" ${required}>`;
				break;
				
			case 'datetime':
				widget = `<input type="datetime-local" id="${inputId}" name="${field.name}" class="form-input" value="${value || ''}" ${required}>`;
				break;
				
			case 'email':
				widget = `<input type="email" id="${inputId}" name="${field.name}" class="form-input" value="${value || ''}" ${required} placeholder="esempio@email.com">`;
				break;
				
			case 'url':
				widget = `<input type="url" id="${inputId}" name="${field.name}" class="form-input" value="${value || ''}" ${required} placeholder="https://esempio.com">`;
				break;
				
			case 'file':
				const fileValue = value ? `<p class="text-sm text-gray-600 mb-2">File attuale: <a href="${value.startsWith('http') ? value : `http://localhost:8000${value.startsWith('/') ? '' : '/media/'}${value}`}" target="_blank" class="text-blue-600">${value.split('/').pop()}</a></p>` : '';
				widget = `
					${fileValue}
					<input type="file" id="${inputId}" name="${field.name}" class="form-input file-input" ${!value ? required : ''} accept="*/*">
					${value ? '<input type="hidden" name="keep_' + field.name + '" value="' + value + '">' : ''}
				`;
				break;
				
			case 'image':
				const imageValue = value ? `
					<div class="mb-2">
						<p class="text-sm text-gray-600">Immagine attuale:</p>
						<img src="${value.startsWith('http') ? value : `http://localhost:8000${value.startsWith('/') ? '' : '/media/'}${value}`}" alt="Preview" class="image-preview" onclick="window.open(this.src, '_blank')">
					</div>
				` : '';
				widget = `
					${imageValue}
					<input type="file" id="${inputId}" name="${field.name}" class="form-input file-input" ${!value ? required : ''} accept="image/*">
					${value ? '<input type="hidden" name="keep_' + field.name + '" value="' + value + '">' : ''}
				`;
				break;
				
			case 'foreign_key':
				// Select vuoto che verr√† popolato dalla funzione loadForeignKeyOptions
				widget = `
					<select id="${inputId}" name="${field.name}" class="form-select" ${required} data-foreign-key="${field.related_model || field.name}">
						<option value="">Caricamento opzioni...</option>
					</select>
				`;
				break;
				
			default: // char
				widget = `<input type="text" id="${inputId}" name="${field.name}" class="form-input" value="${value || ''}" ${required} placeholder="Inserisci ${label.toLowerCase()}...">`;
		}

		return `
			<div class="form-group">
				<label class="form-label" for="${inputId}">
					${label} ${field.required ? '<span class="required">*</span>' : ''}
				</label>
				${widget}
				${helpText}
			</div>
		`;
	}

	// Carica le opzioni per i campi ForeignKey
	async function loadForeignKeyOptions() {
		if (!currentModel?.meta_fields) return;
		
		const token = localStorage.getItem('authToken');
		
		for (const field of currentModel.meta_fields) {
			if (field.field_type === 'foreign_key') {
				try {
					const selectElement = document.querySelector(`select[data-foreign-key="${field.related_model || field.name}"]`);
					if (!selectElement) continue;
					
					// Determina il modello di riferimento
					let relatedModel = field.related_model || field.to;
					if (!relatedModel) {
						// Prova a dedurlo dal nome del campo
						relatedModel = field.name.charAt(0).toUpperCase() + field.name.slice(1);
					}
					
					const response = await fetch(`http://localhost:8000/api/data/${relatedModel}/`, {
						headers: {
							'Authorization': `Token ${token}`,
							'Content-Type': 'application/json'
						}
					});
					
					if (response.ok) {
						const data = await response.json();
						const records = data.results || data;
						
						// Popola la select
						selectElement.innerHTML = `
							<option value="">Seleziona ${field.verbose_name || field.name}...</option>
							${records.map(record => `
								<option value="${record.id}">
									${record.title || record.name || record.toString || `${relatedModel} #${record.id}`}
								</option>
							`).join('')}
						`;
						
						// Se c'√® un valore preselezionato, impostalo
						const currentValue = selectElement.getAttribute('data-current-value');
						if (currentValue) {
							selectElement.value = currentValue;
						}
					} else {
						selectElement.innerHTML = `<option value="">Errore nel caricamento</option>`;
					}
				} catch (error) {
					console.error(`Errore nel caricamento opzioni per ${field.name}:`, error);
				}
			}
		}
	}

	// Funzione per salvare record (separata per riuso)
	async function saveRecord(formData, recordId = null, hasFiles = false) {
		const token = localStorage.getItem('authToken');
		
		// Prepara headers e body in base al tipo di dati
		const headers = {
			'Authorization': `Token ${token}`
		};
		
		let body;
		if (hasFiles) {
			// Per i file, non impostare Content-Type (il browser lo far√† automaticamente con boundary)
			body = formData; // FormData object
		} else {
			// Per dati JSON normali
			headers['Content-Type'] = 'application/json';
			body = JSON.stringify(formData);
		}
		
		let response;
		if (recordId) {
			// Modifica record esistente
			response = await fetch(`http://localhost:8000/api/data/${modelName}/${recordId}/`, {
				method: 'PUT',
				headers,
				body
			});
		} else {
			// Crea nuovo record
			response = await fetch(`http://localhost:8000/api/data/${modelName}/`, {
				method: 'POST',
				headers,
				body
			});
		}

		if (response.ok) {
			const savedRecord = await response.json();
			
			// Aggiorna array locale
			if (recordId) {
				const index = currentData.findIndex(r => r.id === recordId);
				if (index !== -1) {
					currentData[index] = savedRecord;
				}
			} else {
				currentData.push(savedRecord);
			}

			// Aggiorna UI
			updateStats();
			renderTable();
			
			// Feedback positivo
			showSuccessMessage(recordId ? 'Record aggiornato con successo!' : 'Record creato con successo!');
		} else {
			const error = await response.json();
			throw new Error(JSON.stringify(error));
		}
	}

	// Funzione per mostrare messaggi di successo
	function showSuccessMessage(message) {
		const successMsg = document.createElement('div');
		successMsg.className = 'alert alert-success';
		successMsg.textContent = `‚úÖ ${message}`;
		successMsg.style.position = 'fixed';
		successMsg.style.top = '20px';
		successMsg.style.right = '20px';
		successMsg.style.zIndex = '9999';
		document.body.appendChild(successMsg);
		
		setTimeout(() => successMsg.remove(), 3000);
	}

	// Rendi le funzioni globalmente accessibili
	window.showAddModal = showAddModal;
	window.editRecord = editRecord;
	window.deleteRecord = deleteRecord;
	window.refreshData = refreshData;
	window.closeRecordModal = closeRecordModal;

	// Funzione intelligente per tornare indietro
	window.goBack = function() {
		// Se c'√® history e non siamo nella prima pagina
		if (window.history.length > 1 && document.referrer) {
			window.history.back();
		} else {
			// Fallback: vai alla pagina dati
			window.location.href = '/data';
		}
	};

	function generateFormFields(record = null) {
		// Questa funzione ora sar√† gestita da Vue
		console.log('Form fields will be handled by Vue components');
	}

	function closeRecordModal() {
		document.getElementById('record-modal')!.style.display = 'none';
		// Cleanup del form
		const container = document.getElementById('vue-form-container');
		if (container) {
			container.innerHTML = '';
		}
	}

	async function deleteRecord(id) {
		if (!confirm('Sei sicuro di voler eliminare questo record?')) return;

		try {
			const token = localStorage.getItem('authToken');
			const response = await fetch(`http://localhost:8000/api/data/${modelName}/${id}/`, {
				method: 'DELETE',
				headers: {
					'Authorization': `Token ${token}`,
					'Content-Type': 'application/json'
				}
			});

			if (response.ok) {
				// Rimuovi dall'array locale e aggiorna tabella
				currentData = currentData.filter(r => r.id !== id);
				updateStats();
				renderTable();
				
				// Feedback positivo
				const successMsg = document.createElement('div');
				successMsg.className = 'alert alert-success';
				successMsg.textContent = '‚úÖ Record eliminato con successo!';
				successMsg.style.position = 'fixed';
				successMsg.style.top = '20px';
				successMsg.style.right = '20px';
				successMsg.style.zIndex = '9999';
				document.body.appendChild(successMsg);
				
				setTimeout(() => successMsg.remove(), 3000);
			} else {
				throw new Error('Errore nell\'eliminazione');
			}
		} catch (error) {
			console.error('Errore:', error);
			alert('‚ùå Errore nell\'eliminazione del record');
		}
	}

	async function refreshData() {
		document.getElementById('loading')!.style.display = 'block';
		document.getElementById('content')!.style.display = 'none';
		await loadModelAndData();
	}

	// Chiudi modal cliccando fuori
	document.getElementById('record-modal')?.addEventListener('click', (e) => {
		if (e.target === e.currentTarget) {
			closeRecordModal();
		}
	});

	// Setup search functionality
	document.getElementById('search-input')?.addEventListener('input', (e) => {
		const searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
		filterTable(searchTerm);
	});

	function filterTable(searchTerm) {
		const tbody = document.getElementById('table-body');
		if (!tbody) return;

		const rows = tbody.querySelectorAll('tr');
		
		rows.forEach(row => {
			const text = row.textContent?.toLowerCase() || '';
			row.style.display = text.includes(searchTerm) ? '' : 'none';
		});

		// Mostra messaggio se nessun risultato
		const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
		const noDataEl = document.getElementById('no-data');
		
		if (visibleRows.length === 0 && searchTerm) {
			const tbody = document.getElementById('table-body');
			if (tbody && noDataEl) {
				tbody.style.display = 'none';
				noDataEl.style.display = 'block';
				noDataEl.innerHTML = `
					<p class="text-muted">Nessun risultato per "${searchTerm}"</p>
					<button class="btn btn-secondary" onclick="clearSearch()">Cancella ricerca</button>
				`;
			}
		} else {
			if (tbody) tbody.style.display = '';
			if (noDataEl && currentData.length > 0) noDataEl.style.display = 'none';
		}
	}

	// Global function per cancellare la ricerca
	window.clearSearch = function() {
		const searchInput = document.getElementById('search-input') as HTMLInputElement;
		if (searchInput) {
			searchInput.value = '';
			filterTable('');
		}
	};
</script>
</Layout>